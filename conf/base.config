/*
 * Resource allocation configurations.
 * Labels can be adjusted in the processes.nf.
 * Updated for Nextflow strict syntax - no check_max() calls, no if statements
 */

process {
  errorStrategy = 'retry'
  maxRetries = 5

  // Process-specific resource requirements
  // See https://www.nextflow.io/docs/latest/config.html#config-process-selectors

  withName: 'download_star_index' {
    cpus = 1
    memory = { 4.GB * task.attempt }
    scratch = true
  }
  withName: 'download_gtf' {
    cpus = 1
    memory = { 4.GB * task.attempt }
    scratch = true
  }
  withName: 'download_input_csv' {
    cpus = 1
    memory = { 4.GB * task.attempt }
    scratch = true
  }
  withName: 'download_barcode_list' {
    cpus = 1
    memory = { 4.GB * task.attempt }
    scratch = true
  }
  withName: 'download_public_fastq' {
    cpus = 1
    memory = { 4.GB * task.attempt }
  }
  withName: 'features_file' {
    cpus = 2
    memory = { 8.GB * task.attempt }
  }
  withName: 'merge_lanes' {
    cpus = 1
    memory = { 4.GB * task.attempt }
  }
  withName: qc {
    cpus = 2
    memory = { 4.GB * task.attempt }
  }
  // STAR alignment - mixed species requires more memory
  withName: star {
    cpus = 16
    memory = { (params.genome == "mouse_human_mix" ? 60.GB : 40.GB) * task.attempt }
  }
  withName: create_valid_empty_bam {
    cpus = 1
    memory = { 1.GB * task.attempt }
  }
  withName: gtf2bed {
    cpus = 1
    memory = { 6.GB * task.attempt }
  }
  withName: run_rseqc {
    cpus = 2
    memory = { 2.GB * task.attempt }
  }
  withName: initial_feature_count {
    cpus = 4
    memory = { 4.GB * task.attempt }
  }
  withName: 'filter_for_UMRs_mismatch' {
    cpus = 1
    memory = { 2.GB * task.attempt }
  }
  withName: single_sample_multiqc {
    cpus = 1
    memory = { 1.GB * task.attempt }
  }
  withName: multi_sample_multiqc {
    cpus = 1
    memory = { 1.GB * task.attempt }
  }
  withName: sort_index_bam {
    cpus = 1
    memory = { 2.GB * task.attempt }
  }
  withName: dedup {
    cpus = 4
    memory = { 8.GB * task.attempt }
  }
  withName: io_count {
    cpus = 4
    memory = { 1.GB * task.attempt }
  }
  withName: count_matrix {
    cpus = 4
    memory = { 6.GB * task.attempt }
  }
  withName: cell_caller {
    cpus = 4
    memory = { 2.GB * task.attempt }
  }
  withName: filter_count_matrix {
    cpus = 2
    memory = { 4.GB * task.attempt }
  }
  withName: categorize_reads {
    cpus = 2
    memory = { 4.GB * task.attempt }
  }
  withName: summary_statistics {
    cpus = 1
    memory = { 8.GB * task.attempt }
  }
  withName: qc_cascade_plot_single {
    cpus = 1
    memory = { 2.GB * task.attempt }
  }
  withName: qc_cascade_plot_multi {
    cpus = 1
    memory = { 2.GB * task.attempt }
  }
  withName: single_summary_report {
    cpus = 4
    memory = { 4.GB * task.attempt }
  }
  withName: multi_sample_report {
    cpus = 2
    memory = { 4.GB * task.attempt }
  }
  withName: 'save_resolved_configuration' {
    cpus = 1
    memory = { 1.GB * task.attempt }
  }
  withName: 'download_barcode_correction_list' {
    cpus = 1
    memory = { 4.GB * task.attempt }
    scratch = true
  }
  withName: 'umr_transcript_assignment' {
    cpus = 1
    memory = { 1.GB * task.attempt }
  }
  withName: 'umr_exon_assignment' {
    cpus = 1
    memory = { 1.GB * task.attempt }
  }
  withName: 'filter_for_multimappers_mismatch' {
    cpus = 1
    memory = { 1.GB * task.attempt }
  }
  withName: 'merge_transcript_exon_umr_bams' {
    cpus = 1
    memory = { 1.GB * task.attempt }
  }
  withName: 'merge_transcript_exon_multimapper_bams' {
    cpus = 1
    memory = { 1.GB * task.attempt }
  }
  withName: 'merge_annotated_UMRs_with_annotated_multimappers' {
    cpus = 1
    memory = { 1.GB * task.attempt }
  }
  withName: 'count_high_conf_annotated_umr_multimap' {
    cpus = 1
    memory = { 1.GB * task.attempt }
  }
  withName: 'multimapper_transcript_assignment' {
    cpus = 1
    memory = { 2.GB * task.attempt }
  }
  withName: 'multimapper_exon_assignment' {
    cpus = 1
    memory = { 2.GB * task.attempt }
  }
}

